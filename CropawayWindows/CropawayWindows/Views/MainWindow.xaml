<Window x:Class="CropawayWindows.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:CropawayWindows.ViewModels"
        xmlns:views="clr-namespace:CropawayWindows.Views"
        xmlns:controls="clr-namespace:CropawayWindows.Controls"
        mc:Ignorable="d"
        Title="Cropaway"
        Width="1400" Height="900"
        MinWidth="900" MinHeight="600"
        Background="{StaticResource BackgroundBrush}"
        Foreground="{StaticResource TextPrimaryBrush}"
        AllowDrop="True"
        Drop="OnFileDrop"
        DragOver="OnDragOver"
        PreviewKeyDown="OnKeyDown"
        WindowStartupLocation="CenterScreen"
        Icon="/Resources/cropaway.ico">

    <Window.DataContext>
        <vm:MainViewModel />
    </Window.DataContext>

    <!-- Menu Bar -->
    <DockPanel>
        <Menu DockPanel.Dock="Top" Background="{StaticResource SurfaceBrush}" Foreground="{StaticResource TextPrimaryBrush}">
            <Menu.ItemContainerStyle>
                <Style TargetType="MenuItem">
                    <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
                </Style>
            </Menu.ItemContainerStyle>

            <MenuItem Header="_File">
                <MenuItem Header="_Open Videos..." Command="{Binding Project.OpenVideosCommand}" InputGestureText="Ctrl+O" />
                <MenuItem Header="_Add Videos..." Command="{Binding Project.OpenVideosCommand}" InputGestureText="Ctrl+N" />
                <Separator />
                <MenuItem Header="_Export..." Command="{Binding ExportCurrentVideoCommand}" InputGestureText="Ctrl+E" />
                <MenuItem Header="Export _All..." Command="{Binding ExportAllCommand}" InputGestureText="Ctrl+Shift+E" />
                <MenuItem Header="Export Crop _JSON..." Command="{Binding ExportCropJsonCommand}" InputGestureText="Ctrl+Shift+J" />
                <Separator />
                <MenuItem Header="_Reveal in Explorer" Command="{Binding RevealInExplorerCommand}" />
                <Separator />
                <MenuItem Header="_Remove Selected Video" Command="{Binding Project.RemoveSelectedVideoCommand}" InputGestureText="Ctrl+Delete" />
            </MenuItem>

            <MenuItem Header="_Edit">
                <MenuItem Header="_Undo" Command="{Binding UndoCommand}" InputGestureText="Ctrl+Z" />
                <MenuItem Header="_Redo" Command="{Binding RedoCommand}" InputGestureText="Ctrl+Shift+Z" />
                <Separator />
                <MenuItem Header="_Copy Crop Settings" Command="{Binding CopyCropSettingsCommand}" InputGestureText="Ctrl+C" />
                <MenuItem Header="_Paste Crop Settings" Command="{Binding PasteCropSettingsCommand}" InputGestureText="Ctrl+V" />
                <Separator />
                <MenuItem Header="_Reset Crop" Command="{Binding ResetCropCommand}" InputGestureText="Ctrl+Shift+R" />
                <Separator />
                <MenuItem Header="_Preferences..." Command="{Binding ShowSettingsCommand}" InputGestureText="Ctrl+," />
            </MenuItem>

            <MenuItem Header="_View">
                <MenuItem Header="Zoom _In" Command="{Binding ZoomInCommand}" InputGestureText="Ctrl++" />
                <MenuItem Header="Zoom _Out" Command="{Binding ZoomOutCommand}" InputGestureText="Ctrl+-" />
                <MenuItem Header="_Actual Size" Command="{Binding ActualSizeCommand}" InputGestureText="Ctrl+0" />
                <MenuItem Header="_Fit to Window" Command="{Binding ZoomToFitCommand}" InputGestureText="Ctrl+9" />
                <Separator />
                <MenuItem Header="Toggle _Sidebar" Command="{Binding ToggleSidebarCommand}" InputGestureText="Ctrl+Alt+S" />
                <MenuItem Header="Toggle _Keyframes" Command="{Binding ToggleKeyframePanelCommand}" />
                <MenuItem Header="Toggle _Timeline" Command="{Binding ToggleTimelinePanelCommand}" />
            </MenuItem>

            <MenuItem Header="_Crop">
                <MenuItem Header="_Rectangle" Command="{Binding SetCropModeCommand}" CommandParameter="Rectangle" InputGestureText="Ctrl+1" />
                <MenuItem Header="_Circle" Command="{Binding SetCropModeCommand}" CommandParameter="Circle" InputGestureText="Ctrl+2" />
                <MenuItem Header="Custom _Mask" Command="{Binding SetCropModeCommand}" CommandParameter="Freehand" InputGestureText="Ctrl+3" />
                <MenuItem Header="_AI Track" Command="{Binding SetCropModeCommand}" CommandParameter="AI" InputGestureText="Ctrl+4" />
                <Separator />
                <MenuItem Header="Add _Keyframe" Command="{Binding AddKeyframeCommand}" InputGestureText="Ctrl+K" />
                <MenuItem Header="_Remove Keyframe" Command="{Binding RemoveKeyframeCommand}" InputGestureText="Ctrl+Shift+K" />
            </MenuItem>

            <MenuItem Header="_Playback">
                <MenuItem Header="_Play/Pause" Command="{Binding Player.TogglePlayPauseCommand}" InputGestureText="Space" />
                <Separator />
                <MenuItem Header="Step _Forward" Command="{Binding Player.StepForwardCommand}" InputGestureText="Right" />
                <MenuItem Header="Step _Backward" Command="{Binding Player.StepBackwardCommand}" InputGestureText="Left" />
                <Separator />
                <MenuItem Header="Shuttle Back (J)" Command="{Binding Player.ShuttleReverseCommand}" InputGestureText="J" />
                <MenuItem Header="Shuttle Stop (K)" Command="{Binding Player.ShuttleStopCommand}" InputGestureText="K" />
                <MenuItem Header="Shuttle Forward (L)" Command="{Binding Player.ShuttleForwardCommand}" InputGestureText="L" />
                <Separator />
                <MenuItem Header="_Loop Playback" Command="{Binding Player.ToggleLoopCommand}" InputGestureText="Ctrl+L" />
                <MenuItem Header="Toggle _Frame Display" Command="{Binding Player.ToggleTimeDisplayCommand}" InputGestureText="Ctrl+Alt+T" />
            </MenuItem>

            <MenuItem Header="_Timeline">
                <MenuItem Header="_Split Clip at Playhead" Command="{Binding Timeline.SplitClipAtPlayheadCommand}" InputGestureText="Ctrl+B" />
                <Separator />
                <MenuItem Header="_Next Clip" Command="{Binding Timeline.GoToNextClipCommand}" />
                <MenuItem Header="_Previous Clip" Command="{Binding Timeline.GoToPreviousClipCommand}" />
                <Separator />
                <MenuItem Header="_Add Selected to Sequence" Command="{Binding AddToSequenceCommand}" InputGestureText="Ctrl+=" />
            </MenuItem>

            <MenuItem Header="_Help">
                <MenuItem Header="_About Cropaway" Command="{Binding ShowAboutCommand}" />
            </MenuItem>
        </Menu>

        <!-- Crop Toolbar -->
        <Border DockPanel.Dock="Top" Background="{StaticResource SurfaceBrush}"
                BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1"
                Padding="8,4">
            <DockPanel>
                <!-- Crop mode selector -->
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Left" Margin="0,0,16,0">
                    <ToggleButton Style="{StaticResource CropModeToggle}"
                                  IsChecked="{Binding CropEditor.Mode, Converter={StaticResource EnumBoolConverter}, ConverterParameter=Rectangle}"
                                  Command="{Binding SetCropModeCommand}" CommandParameter="Rectangle"
                                  ToolTip="Rectangle Crop (Ctrl+1)">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock FontFamily="Segoe Fluent Icons" Text="&#xE003;" FontSize="14" Margin="0,0,4,0" />
                            <TextBlock Text="Rectangle" />
                        </StackPanel>
                    </ToggleButton>
                    <ToggleButton Style="{StaticResource CropModeToggle}"
                                  IsChecked="{Binding CropEditor.Mode, Converter={StaticResource EnumBoolConverter}, ConverterParameter=Circle}"
                                  Command="{Binding SetCropModeCommand}" CommandParameter="Circle"
                                  ToolTip="Circle Crop (Ctrl+2)" Margin="4,0,0,0">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock FontFamily="Segoe Fluent Icons" Text="&#xEA3A;" FontSize="14" Margin="0,0,4,0" />
                            <TextBlock Text="Circle" />
                        </StackPanel>
                    </ToggleButton>
                    <ToggleButton Style="{StaticResource CropModeToggle}"
                                  IsChecked="{Binding CropEditor.Mode, Converter={StaticResource EnumBoolConverter}, ConverterParameter=Freehand}"
                                  Command="{Binding SetCropModeCommand}" CommandParameter="Freehand"
                                  ToolTip="Custom Mask (Ctrl+3)" Margin="4,0,0,0">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock FontFamily="Segoe Fluent Icons" Text="&#xEE56;" FontSize="14" Margin="0,0,4,0" />
                            <TextBlock Text="Mask" />
                        </StackPanel>
                    </ToggleButton>
                    <ToggleButton Style="{StaticResource CropModeToggle}"
                                  IsChecked="{Binding CropEditor.Mode, Converter={StaticResource EnumBoolConverter}, ConverterParameter=AI}"
                                  Command="{Binding SetCropModeCommand}" CommandParameter="AI"
                                  ToolTip="AI Track (Ctrl+4)" Margin="4,0,0,0">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock FontFamily="Segoe Fluent Icons" Text="&#xE945;" FontSize="14" Margin="0,0,4,0" />
                            <TextBlock Text="AI Track" />
                        </StackPanel>
                    </ToggleButton>
                </StackPanel>

                <!-- Separator -->
                <Rectangle Width="1" Fill="{StaticResource BorderBrush}" DockPanel.Dock="Left" Margin="8,2" />

                <!-- Keyframe buttons -->
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Left" Margin="8,0">
                    <Button Style="{StaticResource ToolbarButton}" Command="{Binding AddKeyframeCommand}" ToolTip="Add Keyframe (Ctrl+K)">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock FontFamily="Segoe Fluent Icons" Text="&#xE710;" FontSize="12" Margin="0,0,4,0" />
                            <TextBlock Text="Keyframe" />
                        </StackPanel>
                    </Button>
                    <Button Style="{StaticResource ToolbarButton}" Command="{Binding ToggleKeyframePanelCommand}" ToolTip="Toggle Keyframe Timeline" Margin="4,0,0,0">
                        <TextBlock FontFamily="Segoe Fluent Icons" Text="&#xE9D5;" FontSize="14" />
                    </Button>
                </StackPanel>

                <!-- Right-side tools -->
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Right" HorizontalAlignment="Right">
                    <!-- Export settings -->
                    <CheckBox Content="Preserve Width" IsChecked="{Binding CropEditor.PreserveWidth}"
                              Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,12,0" VerticalAlignment="Center" />
                    <CheckBox Content="Alpha Channel" IsChecked="{Binding CropEditor.EnableAlphaChannel}"
                              Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,12,0" VerticalAlignment="Center" />

                    <Button Style="{StaticResource AccentButton}" Command="{Binding ExportCurrentVideoCommand}" ToolTip="Export Video (Ctrl+E)">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock FontFamily="Segoe Fluent Icons" Text="&#xEDE1;" FontSize="14" Margin="0,0,6,0" />
                            <TextBlock Text="Export" />
                        </StackPanel>
                    </Button>
                </StackPanel>

                <!-- Spacer -->
                <Border />
            </DockPanel>
        </Border>

        <!-- Numeric Crop Input Panel -->
        <views:CropInputPanel DockPanel.Dock="Top" />

        <!-- Status Bar -->
        <Border DockPanel.Dock="Bottom" Background="{StaticResource SurfaceBrush}"
                BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,1,0,0"
                Padding="8,3">
            <DockPanel>
                <TextBlock Text="{Binding StatusBarText}" Foreground="{StaticResource TextSecondaryBrush}"
                           FontSize="11" VerticalAlignment="Center" />

                <!-- Export progress -->
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Right" HorizontalAlignment="Right"
                            Visibility="{Binding Export.IsExporting, Converter={StaticResource BoolToVisConverter}}">
                    <ProgressBar Style="{StaticResource ExportProgress}" Width="120"
                                 Value="{Binding Export.OverallProgress}" Maximum="1" Margin="0,0,8,0" />
                    <Button Style="{StaticResource ToolbarButton}" Command="{Binding Export.CancelExportCommand}"
                            Content="Cancel" FontSize="11" Padding="4,2" />
                </StackPanel>
            </DockPanel>
        </Border>

        <!-- Main Content Area (wrapped in a Grid so ExportProgressView can overlay) -->
        <Grid>
            <!-- Primary layout -->
            <Grid>
                <Grid.ColumnDefinitions>
                    <!-- Sidebar -->
                    <ColumnDefinition Width="220" x:Name="SidebarColumn" />
                    <!-- Splitter -->
                    <ColumnDefinition Width="Auto" />
                    <!-- Main editor -->
                    <ColumnDefinition Width="*" />
                    <!-- AI Editor panel (collapsible) -->
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- Video Sidebar -->
                <Border Grid.Column="0" Background="{StaticResource SidebarBrush}"
                        BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,1,0"
                        Visibility="{Binding IsSidebarVisible, Converter={StaticResource BoolToVisConverter}}">
                    <views:VideoSidebarView DataContext="{Binding Project}" />
                </Border>

                <!-- Splitter -->
                <GridSplitter Grid.Column="1" Width="4" Background="Transparent"
                              HorizontalAlignment="Center" VerticalAlignment="Stretch"
                              Visibility="{Binding IsSidebarVisible, Converter={StaticResource BoolToVisConverter}}" />

                <!-- Main Editor Area -->
                <Grid Grid.Column="2">
                    <Grid.RowDefinitions>
                        <!-- Video preview + crop overlay -->
                        <RowDefinition Height="*" />
                        <!-- Player controls -->
                        <RowDefinition Height="Auto" />
                        <!-- Keyframe timeline (collapsible) -->
                        <RowDefinition Height="Auto" />
                        <!-- Timeline (collapsible) -->
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <!-- Video Preview with Crop Overlay -->
                    <Grid Grid.Row="0" Background="#000000">
                        <!-- Video player -->
                        <MediaElement x:Name="VideoPlayer"
                                      Source="{Binding Player.MediaSource}"
                                      LoadedBehavior="Manual" UnloadedBehavior="Manual"
                                      ScrubbingEnabled="True"
                                      Stretch="Uniform" />

                        <!-- Crop overlay (drawn on top of video) -->
                        <controls:CropOverlayControl
                            DataContext="{Binding CropEditor}"
                            VideoWidth="{Binding DataContext.Player.VideoSize.Width, RelativeSource={RelativeSource AncestorType=Window}}"
                            VideoHeight="{Binding DataContext.Player.VideoSize.Height, RelativeSource={RelativeSource AncestorType=Window}}">
                            <controls:CropOverlayControl.ContextMenu>
                                <ContextMenu Background="{StaticResource SurfaceBrush}"
                                             Foreground="{StaticResource TextPrimaryBrush}"
                                             BorderBrush="{StaticResource BorderBrush}">
                                    <MenuItem Header="Reset Crop"
                                              Command="{Binding DataContext.ResetCropCommand, RelativeSource={RelativeSource AncestorType=Window}}">
                                        <MenuItem.Icon>
                                            <TextBlock FontFamily="Segoe Fluent Icons"
                                                       Text="{StaticResource IconReset}"
                                                       FontSize="12" />
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <MenuItem Header="Copy Crop"
                                              Command="{Binding DataContext.CopyCropSettingsCommand, RelativeSource={RelativeSource AncestorType=Window}}">
                                        <MenuItem.Icon>
                                            <TextBlock FontFamily="Segoe Fluent Icons"
                                                       Text="{StaticResource IconCopy}"
                                                       FontSize="12" />
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <MenuItem Header="Paste Crop"
                                              Command="{Binding DataContext.PasteCropSettingsCommand, RelativeSource={RelativeSource AncestorType=Window}}">
                                        <MenuItem.Icon>
                                            <TextBlock FontFamily="Segoe Fluent Icons"
                                                       Text="{StaticResource IconPaste}"
                                                       FontSize="12" />
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <Separator Background="{StaticResource BorderBrush}" />
                                    <MenuItem Header="Rectangle Mode"
                                              Command="{Binding DataContext.SetCropModeCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                              CommandParameter="Rectangle">
                                        <MenuItem.Icon>
                                            <TextBlock FontFamily="Segoe Fluent Icons"
                                                       Text="{StaticResource IconRectangle}"
                                                       FontSize="12" />
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <MenuItem Header="Circle Mode"
                                              Command="{Binding DataContext.SetCropModeCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                              CommandParameter="Circle">
                                        <MenuItem.Icon>
                                            <TextBlock FontFamily="Segoe Fluent Icons"
                                                       Text="{StaticResource IconCircle}"
                                                       FontSize="12" />
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <MenuItem Header="Mask Mode"
                                              Command="{Binding DataContext.SetCropModeCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                              CommandParameter="Freehand">
                                        <MenuItem.Icon>
                                            <TextBlock FontFamily="Segoe Fluent Icons"
                                                       Text="{StaticResource IconFreehand}"
                                                       FontSize="12" />
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <MenuItem Header="AI Track Mode"
                                              Command="{Binding DataContext.SetCropModeCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                              CommandParameter="AI">
                                        <MenuItem.Icon>
                                            <TextBlock FontFamily="Segoe Fluent Icons"
                                                       Text="{StaticResource IconAI}"
                                                       FontSize="12" />
                                        </MenuItem.Icon>
                                    </MenuItem>
                                </ContextMenu>
                            </controls:CropOverlayControl.ContextMenu>
                        </controls:CropOverlayControl>

                        <!-- Drop hint when no video -->
                        <Border Background="#80000000"
                                Visibility="{Binding Project.SelectedVideo, Converter={StaticResource NullToVisConverter}}">
                            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                <TextBlock FontFamily="Segoe Fluent Icons" Text="&#xE714;" FontSize="48"
                                           Foreground="{StaticResource TextTertiaryBrush}" HorizontalAlignment="Center" />
                                <TextBlock Text="Drop videos here or use File > Open" FontSize="16"
                                           Foreground="{StaticResource TextSecondaryBrush}" Margin="0,12,0,0" />
                                <TextBlock Text="Supports MP4, MOV, AVI, MKV, WebM, ProRes" FontSize="12"
                                           Foreground="{StaticResource TextTertiaryBrush}" Margin="0,4,0,0"
                                           HorizontalAlignment="Center" />
                            </StackPanel>
                        </Border>

                        <!-- Rate display overlay -->
                        <TextBlock Text="{Binding Player.RateDisplayString}" FontSize="14" FontWeight="Bold"
                                   Foreground="#80FFFFFF" HorizontalAlignment="Right" VerticalAlignment="Top"
                                   Margin="0,8,12,0" />
                    </Grid>

                    <!-- Player Controls -->
                    <views:VideoPlayerControlsView Grid.Row="1" DataContext="{Binding}" />

                    <!-- Keyframe Timeline Panel -->
                    <Border Grid.Row="2" Background="{StaticResource PanelBrush}"
                            BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,1,0,0"
                            Height="120"
                            Visibility="{Binding IsKeyframePanelVisible, Converter={StaticResource BoolToVisConverter}}">
                        <views:KeyframeTimelineView DataContext="{Binding Keyframes}" />
                    </Border>

                    <!-- Timeline Panel -->
                    <Border Grid.Row="3" Background="{StaticResource PanelBrush}"
                            BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,1,0,0"
                            Height="160"
                            Visibility="{Binding IsTimelinePanelVisible, Converter={StaticResource BoolToVisConverter}}">
                        <views:TimelineTrackView DataContext="{Binding Timeline}" />
                    </Border>
                </Grid>

                <!-- AI Editor Panel (right side, visible when AI mode is selected) -->
                <Border Grid.Column="3" Width="280"
                        Background="{StaticResource PanelBrush}"
                        BorderBrush="{StaticResource BorderBrush}" BorderThickness="1,0,0,0"
                        Visibility="{Binding IsAIPanelVisible, Converter={StaticResource BoolToVisConverter}}">
                    <views:AIEditorView DataContext="{Binding CropEditor}" />
                </Border>
            </Grid>

            <!-- Export Progress Overlay (on top of everything) -->
            <views:ExportProgressView DataContext="{Binding Export}" />
        </Grid>
    </DockPanel>
</Window>
